trigger: 
- none

variables:
- group: IAC-Non-Prod

# This will compile all the backend processors
pool:
  name: VMSS-Linux-PROD

# Run pipeline tasks in container using FA standard build image
container:
  image: ssppaps1arpscr1.azurecr.io/ubuntu1804-build-agent
  endpoint: DevOps-ACR-PROD

steps:

- task: AWS-Azure-Login-Config@1
  displayName: 'Login aws'
  inputs:
    AzureDefaultUsername: '$(AZURE_DEFAULT_USERNAME)'
    AzureDefaultPassword: '$(AZURE_DEFAULT_PASSWORD)'
    AppName: 'AWS-ESSC-N-0'
    ProgrammaticRoleARN: '$(AZURE_DEFAULT_ROLE_ARN)'
    ProgrammaticProfileName: '$(AWS_PROG_PROFILE)'
    AssumedRoleARN: '$(AWS_ASSUMED_ROLE_ARN)'
    AssumedProfileName: 'tmct_n1_default_devops'
    ProfileRegion: 'us-west-2'
    ActivationDuration: '8'
    InstallAWSCLI: true
    InstallAWSAzureLogin: true
    DebugMode: false


- powershell: |
   echo "removing previous credential and configs"
   Remove-Item -Path "c:\\users\\$($env:USERNAME)\\.aws\\config" -ErrorAction Ignore
   Remove-Item -Path "c:\\users\\$($env:USERNAME)\\.aws\\credentials" -ErrorAction Ignore
   
   echo "setup/ensure winrm is running and able to execute remote calls"
   start-service winrm
   set-item WSMan:\localhost\Client\TrustedHosts -Value * -force
   
  displayName: 'Remove previous AWS credentials'  

- task: BatchScript@1
  displayName: 'AWS Login'
  inputs:
    filename: '\\corp.firstam.com\Apps\SCM\Repo\TeamConnect\TransactionPortal\$(Build.BuildNumber)_ReportByTransactionType\aws-profile-setup-and-login.bat'
    arguments: '"$(AZURE_PASSWORD)"'  

- powershell: |
   $Region = $Env:AWS_REGION
   $Profile = $Env:AWS_ASSUMED_PROFILE
   
   aws lambda update-function-code --function-name ReportTransactionType  --zip-file fileb://lambda.zip --profile $Profile
   
  workingDirectory: '\\corp.firstam.com\Apps\SCM\Repo\TeamConnect\TransactionPortal\$(Build.BuildNumber)_ReportByTransactionType'
  displayName: 'Update ReportTransactionType lambda'    